---
title: "PSPL Site Index Conversion"
output: md_document
---


# PSPL Method 2022  

## Feature_id processing 

- run SI conversion on feature_id based si
- run SI conversion on opening_id based si
- run SI conversion on BEC based si 



Create the following tables:

- pspl_site_index_bec
- pspl_site_index_fid
- pspl_site_index_op


Start: `r format(Sys.time(),"%c")`

```{r setup, echo=TRUE,message=TRUE,warning=TRUE}

year <- '2022'

library(RPostgreSQL)
library(tidyverse)
library(data.table)
library(ggplot2)

# set up for schema and user
schema <- 'msyt_2022'
opt <- paste0("-c search_path=",schema)
user_name <- 'results'
database <- 'msyt'
con <- dbConnect('PostgreSQL',dbname='msyt',user=user_name,options=opt)


#load the R code for site index conversions

si_convert <- paste0(getwd(),'/site_index_conversion_equations_v2.r')
source(si_convert, local = knitr::knit_global())


```

### run SI conversion on the bec means values


- run SI conversion on BEC based si 

This has to be run first as any missing values in fid or opening use this table

```{r bec_si_convert}

# read avg_BEC_data: table = psql_bec_site_index_pre_convert
q1 <- paste0('select *  from msyt_',year,'.pspl_site_index_pre_convert_bec')
r1 <- dbSendQuery(con,q1)
avg_BEC_data <- dbFetch(r1,n=-1)

setDT(avg_BEC_data)


avg_BEC_data <- si_convert(avg_BEC_data)

```


## BEC substitution

mmp is missing all site index values.  
Assume that this is actually mm (since it is one of) and may be next to mm.  

SWB mk, mks, un substitute BWBS dk  



```{r}

## Substitute for MHmmp
mm <- avg_BEC_data %>% subset(bec_zone == 'MH' & bec_subzone == 'mm')
avg_BEC_data <- avg_BEC_data %>% subset(paste0(bec_zone,bec_subzone) != 'MHmmp' )
mm$bec_subzone <- 'mmp'

avg_BEC_data <- rbind(avg_BEC_data,mm)


## substitute for SWB mk,mks,un

# delete the older data
# all SWB data is blank
avg_BEC_data <- avg_BEC_data %>% subset(bec_zone != 'SWB')

swb1 <- avg_BEC_data %>% subset(bec_zone == 'BWBS' & bec_subzone == 'dk')
swb1$bec_zone <- 'SWB'
swb1$bec_subzone <- 'mk'

swb2 <- swb1
swb3 <- swb1

swb2$bec_zone <- 'SWB'
swb2$bec_subzone <- 'mks'

swb3$bec_zone <- 'SWB'
swb3$bec_subzone <- 'un'

avg_BEC_data <- rbind(avg_BEC_data,swb1,swb2,swb3)






# write the data
file_name <- paste0(substr(getwd(),1,1),':/data/data_projects/AR',year,'/PSPL/si_data/pspl_site_index_bec.csv')
fwrite(avg_BEC_data, file_name, col.names=TRUE, row.names=FALSE, quote = FALSE, sep=",")


tbl_name <- paste0('pspl_site_index_bec')


# pre delete table
if(dbExistsTable(con,tbl_name)) {
  dbRemoveTable(con,tbl_name)
}


# write to table
dbWriteTable(con,tbl_name,avg_BEC_data,row.names = FALSE)


```

### Feature_id Site Index Conversions

Run the SI conversion on avg_fid_data.   

mean value data by feature



```{r  si_convert_fid,echo=TRUE,message=TRUE,warning=TRUE}


# read avg_fid_data: table = pspl_site_index_pre_convert_fid
# this is the mean value feature_id data

q1 <- paste0('select *  from msyt_',year,'.pspl_site_index_pre_convert_fid')
avg_fid_data <- dbGetQuery(con,q1)
 

setDT(avg_fid_data)

# note that si_convert required 0 in place of NA
# si_convert will handle this


# run the SI conversions
avg_fid_data <- si_convert(avg_fid_data)

```


## update converted using BEC converted


- update feature_id si using BEc avg


```{r update1,echo=TRUE,message=TRUE,warning=TRUE}


avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), at_si := ifelse(at_si==0, i.at_si,at_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), ba_si := ifelse(ba_si==0, i.ba_si,ba_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), bg_si := ifelse(bg_si==0, i.bg_si,bg_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), bl_si := ifelse(bl_si==0, i.bl_si,bl_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), cw_si := ifelse(cw_si==0, i.cw_si,cw_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), dr_si := ifelse(dr_si==0, i.dr_si,dr_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), ep_si := ifelse(ep_si==0, i.ep_si,ep_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), fd_si := ifelse(fd_si==0, i.fd_si,fd_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), hm_si := ifelse(hm_si==0, i.hm_si,hm_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), hw_si := ifelse(hw_si==0, i.hw_si,hw_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), lt_si := ifelse(lt_si==0, i.lt_si,lt_si)]  
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), lw_si := ifelse(lw_si==0, i.lw_si,lw_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), pa_si := ifelse(pa_si==0, i.pa_si,pa_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), pl_si := ifelse(pl_si==0, i.pl_si,pl_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), pw_si := ifelse(pw_si==0, i.pw_si,pw_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), py_si := ifelse(py_si==0, i.py_si,py_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), sb_si := ifelse(sb_si==0, i.sb_si,sb_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), se_si := ifelse(se_si==0, i.se_si,se_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), ss_si := ifelse(ss_si==0, i.ss_si,ss_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), sw_si := ifelse(sw_si==0, i.sw_si,sw_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), sx_si := ifelse(sx_si==0, i.sx_si,sx_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), yc_si := ifelse(yc_si==0, i.yc_si,yc_si)]

# where BEC in fid differs fro BEC in op data
# need to use the alternative if available

# add src

avg_fid_data$si_src <- 'PSPL'

# write the data
file_name <- paste0(substr(getwd(),1,1),':/data/data_projects/AR',year,'/PSPL/si_data/pspl_site_index_fid.csv')
fwrite(avg_fid_data, file_name, col.names=TRUE, row.names=FALSE, quote = FALSE, sep=",")


tbl_name <- paste0('pspl_site_index_fid')

# pre delete table
if(dbExistsTable(con,tbl_name)) {
  dbRemoveTable(con,tbl_name)
}

# write to table

dbWriteTable(con,tbl_name,avg_fid_data,row.names = FALSE)

```








## Conversion on Opening

```{r si_convert_op}



# read avg_op_data: table = pspl_site_index_pre_convert_op
q1 <- 'select *  from msyt_2022.pspl_site_index_pre_convert_op'
avg_op_data <- dbGetQuery(con,q1)

setDT(avg_op_data)



# run the conversion

avg_op_data <- si_convert(avg_op_data)

```


## update converted using BEC converted


- update opening_id_id si using BEc avg


```{r}



# update from BEC

avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), at_si := ifelse(at_si==0, i.at_si,at_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), ba_si := ifelse(ba_si==0, i.ba_si,ba_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), bg_si := ifelse(bg_si==0, i.bg_si,bg_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), bl_si := ifelse(bl_si==0, i.bl_si,bl_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), cw_si := ifelse(cw_si==0, i.cw_si,cw_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), dr_si := ifelse(dr_si==0, i.dr_si,dr_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), ep_si := ifelse(ep_si==0, i.ep_si,ep_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), fd_si := ifelse(fd_si==0, i.fd_si,fd_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), hm_si := ifelse(hm_si==0, i.hm_si,hm_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), hw_si := ifelse(hw_si==0, i.hw_si,hw_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), lt_si := ifelse(lt_si==0, i.lt_si,lt_si)]  
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), lw_si := ifelse(lw_si==0, i.lw_si,lw_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), pa_si := ifelse(pa_si==0, i.pa_si,pa_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), pl_si := ifelse(pl_si==0, i.pl_si,pl_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), pw_si := ifelse(pw_si==0, i.pw_si,pw_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), py_si := ifelse(py_si==0, i.py_si,py_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), sb_si := ifelse(sb_si==0, i.sb_si,sb_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), se_si := ifelse(se_si==0, i.se_si,se_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), ss_si := ifelse(ss_si==0, i.ss_si,ss_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), sw_si := ifelse(sw_si==0, i.sw_si,sw_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), sx_si := ifelse(sx_si==0, i.sx_si,sx_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), yc_si := ifelse(yc_si==0, i.yc_si,yc_si)]


# add src

avg_op_data$si_src <- 'PSPL'

# writeout the post conversion file
file_name <-  paste0(substr(getwd(),1,1),':/data/data_projects/AR',year,'/PSPL/si_data/pspl_site_index_op.csv')
fwrite(avg_op_data, file_name, col.names=TRUE, row.names=FALSE, quote = FALSE, sep=",")




tbl_name <- paste0('pspl_site_index_op')

# pre delete table
if(dbExistsTable(con,tbl_name)) {
  dbRemoveTable(con,tbl_name)
}



dbWriteTable(con,tbl_name,avg_op_data,row.names = FALSE)


```


```{r cleanUp, eval=FALSE}
 

if(dbExistsTable(con,'pspl_site_index_pre_convert_fid')) {
  dbRemoveTable(con,'pspl_site_index_pre_convert_fid')
}

if(dbExistsTable(con,'pspl_site_index_pre_convert_op')) {
  dbRemoveTable(con,'pspl_site_index_pre_convert_op')
}

if(dbExistsTable(con,'pspl_site_index_pre_convert_bec')) {
  dbRemoveTable(con,'pspl_site_index_pre_convert_bec')
}

#if(dbExistsTable(con,'pspl_init')) {
#  dbRemoveTable(con,'pspl_init')
#}

#if(dbExistsTable(con,'pspl_raw')) {
#  dbRemoveTable(con,'pspl_raw')
#}

```




```{r dump_table}

pg_dump <- function(t_name,folder){
  
  # -O required to negate ownership
  
  f_out <- paste0(folder,'msyt_',year,'_',t_name,'.sql')
  tbl <- paste0('msyt_',year,'.',t_name)
  
  q1 <- paste0("-d ",
               database,
               " -O",
                " -t ",
                tbl,
               " -f ",
               f_out )
  
  system2("pg_dump",args=q1,stderr=TRUE,wait=TRUE)
  #print(q1)
}

```


```{r dump,echo=FALSE,message=FALSE,warning=FALSE}

folder <- paste0(substr(getwd(),1,1),':/data/data_projects/AR',year,'/pg_dump/')

table <- 'pspl_site_index_bec'
pg_dump(table,folder)

table <- 'pspl_site_index_fid'
pg_dump(table,folder)

table <- 'pspl_site_index_op'
pg_dump(table,folder)




# drop the foreign table

#q1 <- paste0('drop foreign table load_',year,'.veg_comp_lyr_r1_poly')
#dbExecute(con,q1)

```



```{r discon}

dbDisconnect(con)

```



End: `r format(Sys.time(),"%c")`