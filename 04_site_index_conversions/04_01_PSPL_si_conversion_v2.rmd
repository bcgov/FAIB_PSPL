---
title: "PSPL Site Index Conversion"
output: md_document
---


# PSPL Method 2022   

## Version testing

Using version 3

revised BA/BG  
revised SS

## Feature_id processing 

- run SI conversion on feature_id based si
- run SI conversion on opening_id based si
- run SI conversion on BEC based si 



Create the following tables:

- pspl_site_index_bec
- pspl_site_index_fid
- pspl_site_index_op

Requires the following tables:

- pspl_site_index_pre_convert_bec
- pspl_site_index_pre_convert_fid
- pspl_site_index_pre_convert_op



Start: `r format(Sys.time(),"%c")`

```{r setup, echo=TRUE,message=TRUE,warning=TRUE}

year <- '2022'

library(RPostgreSQL)
library(tidyverse)
library(data.table)
library(ggplot2)

# set up for schema and user
schema <- 'msyt_2022'
opt <- paste0("-c search_path=",schema)
user_name <- 'results'
database <- 'msyt'
con <- dbConnect('PostgreSQL',dbname='msyt',user=user_name,options=opt)


#load the R code for site index conversions

#  Versions to test
#si_convert <- paste0(getwd(),'/site_index_conversion_equations_v2a.r')
#si_convert <- paste0(getwd(),'/site_index_conversion_equations_v2b.r')
#si_convert <- paste0(getwd(),'/site_index_conversion_equations_v2c.r')
si_convert <- paste0(getwd(),'/site_index_conversion_equations_v3.r')

#source(si_convert, local = knitr::knit_global())


```

### run SI conversion on the bec means values


- run SI conversion on BEC based si 

This has to be run first as any missing values in fid or opening use this table

```{r bec_si_convert,eval=TRUE} 

# read avg_BEC_data: table = psql_bec_site_index_pre_convert
q1 <- paste0('select *  from msyt_',year,'.pspl_site_index_pre_convert_bec')
avg_BEC_data <- dbGetQuery(con,q1)

species <- dbGetQuery(con,"select bec_zone,bec_subzone,array_to_string(species,',') as species from species_list_bec_agg")




avg_BEC_data <- left_join(avg_BEC_data,species)

avg_BEC_data <- avg_BEC_data %>% subset(!is.na(species))


#avg_BEC_data <- si_convert(avg_BEC_data)

```


## BEC substitution

mmp is missing all site index values.  
Assume that this is actually mm (since it is one of) and may be next to mm.  

SWB mk, mks, un substitute BWBS dk  



```{r bec_sub, eval=TRUE} 

## Substitute for MHmmp
mmp <- avg_BEC_data %>% subset(bec_zone == 'MH' & bec_subzone == 'mmp')
avg_BEC_data <- avg_BEC_data %>% subset(paste0(bec_zone,bec_subzone) != 'MHmmp' )
mm <- avg_BEC_data %>% subset(bec_zone == 'MH' & bec_subzone == 'mm')
mm$bec_subzone <- 'mmp'
mm$species <- mmp$species

avg_BEC_data <- rbind(avg_BEC_data,mm)


## substitute for SWB mk,mks,un
avg_BEC_data <- avg_BEC_data %>% subset(bec_zone != 'SWB')
swb1 <- avg_BEC_data %>% subset(bec_zone == 'BWBS' & bec_subzone == 'dk')

swb1$bec_zone <- 'SWB'
swb1$bec_subzone <- 'mk'

swb2 <- swb1
swb3 <- swb1
swb4 <- swb1

swb2$bec_zone <- 'SWB'
swb2$bec_subzone <- 'mks'

swb3$bec_zone <- 'SWB'
swb3$bec_subzone <- 'un'

swb4$bec_zone <- 'SWB'
swb4$bec_subzone <- 'vk'

avg_BEC_data <- rbind(avg_BEC_data,swb1,swb2,swb3,swb4)

df <- avg_BEC_data %>% subset(bec_zone == 'CWH' & bec_subzone %in% c('ds','mm','vh'))

#df <- avg_BEC_data

# set NA to 0 
df[is.na(df)] <- 0

# convert 3 char species to 2 char
# Cwc,Fdc,Hwc
df$species <- gsub('Cwc','Cw',df$species)
df$species <- gsub('Cwi','Cw',df$species)
df$species <- gsub('Fdc','Fd',df$species)
df$species <- gsub('Fdi','Fd',df$species)
df$species <- gsub('Hwc','Hw',df$species)
df$species <- gsub('Hwi','Hw',df$species)

df$cw_si[df$bec_subzone=='ds'] <- 0
df$hw_si[df$bec_subzone=='vh'] <- 0


df$missing <- case_when(
    grepl('At',df$species) & df$at_si == 0 ~ 'At',
    TRUE ~ ''
  )


  
  sp <- c('Ba','Bg','Bl','Cw','Dr','Ep','Fd','Hm','Hw','Lt','Lw','Pa','Pl','Pw','Py','Sb','Se','Ss','Sw','Yc')
  
  # start with the ba_si column
  n <- 3
  for (s in sp) {
    
    n <- n + 1
    df$missing <- case_when(
      grepl(s,df$species) & df[,n] == 0 ~ paste0(df$missing,':',s),
      TRUE ~ paste0(df$missing,'')
    )
    
  }

# onvert si
  
  df <- df %>% subset(missing != '') %>% select(-species)
  #setDT(df)
  
  
```

```{r conversions}


# Cedar Cw
convert_cw_si <- function(inp){
  coast <- c('CDF','CWH','MH')
  si <- case_when(
    inp$hw_si > 0  & inp$bec_zone %in% c('CDF','CWH','MH') ~  -1.198473280 + 0.954198470 * inp$hw_si ,
    inp$ba_si > 0 ~  0.714694652 + 0.967557249 * inp$ba_si ,
    inp$ss_si > 0 ~ 2.580152661 + 0.764312974 * inp$ss_si ,
    inp$sx_si > 0  & inp$bec_zone %in% coast ~  2.580152661 + 0.764312974 * inp$sx_si ,
    inp$fd_si > 0  & inp$bec_zone %in% coast ~  -1.610687019 + 0.857824425 * inp$fd_si  , 
    inp$sw_si > 0 ~ inp$sw_si, 
    TRUE ~ inp$cw_si )
  
  
  return(si)
  
} 

# alder conversion
# dr is special
convert_dr <- function(inp){
  
  si <- case_when(
    inp$bec_zone %in% c('CWH','CDF','MH') & inp$bec_subzone %in% c('ds','db','xm') ~ inp$fd_si * 0.55,
    inp$bec_zone %in% c('CWH','CDF','MH') ~ inp$fd_si * 0.73,
    TRUE ~ inp$fd_si *0.73
  )
}


#####################################
# Pw Ss

convert_pw <- function(inp){

  si <- case_when(
    inp$fd_si != 0 ~ inp$fd_si, 
    inp$ss_si != 0 ~ inp$ss_si , 
    TRUE ~ inp$pw_si)
  
  return(si)
}




# Coastal Hemlock Hwc
convert_hwc_si <- function(inp){
  si <- case_when(
    inp$cw_si > 0 ~ 1.256000000 + 1.048000000 * inp$cw_si ,
    inp$ba_si > 0 ~  2.005000000 + 1.014000000 * inp$ba_si ,
    inp$ss_si > 0 ~ 3.960000000 + 0.801000000 * inp$ss_si ,
    inp$sx_si > 0  ~ 3.960000000 + 0.801000000 * inp$sx_si ,
    inp$fd_si > 0 ~ -0.432000000 + 0.899000000 * inp$fd_si , 
    TRUE ~ inp$hw_si )
  
  return(si)
  
} 

###########################################################################
# one to one conversions
# vetted by Gord Nigh


# Spruce : Se & Sw

convert_sw_from_se <- function(inp) {
  si <- case_when(
    inp$se_si != 0 ~ inp$se_si ,
    TRUE ~ inp$sw_si)
  
  return(si)
  
}

convert_sw_from_sx <- function(inp) {

  si <- case_when(
    inp$sx_si != 0 ~ inp$sx_si , 
    TRUE ~ inp$sw_si)
  
  return(si)
  
}

convert_ss_from_sx <- function(inp) {
  si <- case_when(
    inp$bec_zone %in% c('CDF','CWH','MH') &  inp$sx_si != 0 ~ inp$sx_si ,  # only convert for Coastal
    TRUE ~ inp$ss_si)
  
  return(si)
  
}

convert_se_from_sw <- function(inp) {
  si <- case_when(
    inp$sw_si != 0 ~ inp$sw_si , 
    TRUE ~ inp$se_si)
  
  return(si)
}

convert_sx <- function(inp){
  si <- case_when(
    inp$sw_si != 0 ~ inp$sw_si, 
    TRUE ~ inp$sx_si)
  
  return(si)
}


```
  
  


```{r}  

dt <- df

setDT(dt)

#### Spruce
# ********************************************************************
# Spruce   Se Sw Sx all interchange
# set sw = sx
  dt$sw_si[which(dt$sw_si==0)] <- convert_sw_from_sx(dt[which(dt$sw_si==0)]) 

# set sw = se 
  dt$sw_si[which(dt$sw_si==0)] <- convert_sw_from_se(dt[which(dt$sw_si==0)]) 
  
# set se = sw
  dt$se_si[which(dt$se_si==0)] <- convert_se_from_sw(dt[which(dt$se_si==0)])
  
# set ss = sx
  dt$ss_si[which(dt$ss_si==0)] <- convert_ss_from_sx(dt[which(dt$se_si==0)]) 
  
#### Spruce
# **************************************************************************
  
  
# sp <- At 'Ba','Bg','Bl','Cw','Dr','Ep','Fd','Hm','Hw','Lt','Lw','Pa','Pl','Pw','Py','Sb','Se','Ss','Sw','Yc')

# At  
dt$at_si[which(dt$at_si==0 & grepl('At',dt$missing))] <- convert_at_si(dt[which(dt$at_si==0 & grepl('At',dt$missing))])

# Ba 
dt$abasi[which(dt$ba_si==0 & grepl('Ba',dt$missing))] <- convert_ba_si(dt[which(dt$ba_si==0 & grepl('Ba',dt$missing))])

# Bg
dt$bg_si[which(dt$bg_si==0 & grepl('Bg',dt$missing))] <- convert_bg_si(dt[which(dt$bg_si==0 & grepl('Bg',dt$missing))])

# Bl
dt$bl_si[which(dt$bl_si==0 & grepl('Bl',dt$missing))] <- convert_bl_si(dt[which(dt$bl_si==0 & grepl('Bl',dt$missing))])

# Cwc
dt$cw_si[which(dt$cw_si==0 & grepl('Cw',dt$missing))] <- convert_cw_si(dt[which(dt$cw_si==0 & grepl('Cw',dt$missing))])

# Dr Coast/Interior
dt$dr_si[which(dt$dr_si==0 & grepl('Dr',dt$missing))] <- convert_dr(dt[which(dt$dr_si==0 & grepl('Dr',dt$missing))])

# Fdc
dt$hw_si[which(dt$fd_si==0 & grepl('Fd',dt$missing) & dt$bec_zone %in% c('CDF','CWH','MH') )] <- convert_fdc_si(dt[which(dt$fd_si==0 & grepl('Fd',dt$missing) & dt$bec_zone %in% c('CDF','CWH','MH') )])

# Fdi
dt$hw_si[which(dt$fd_si==0 & grepl('Fd',dt$missing) & !dt$bec_zone %in% c('CDF','CWH','MH') )] <- convert_fdi_si(dt[which(dt$fd_si==0 & grepl('Fd',dt$missing) & !dt$bec_zone %in% c('CDF','CWH','MH') )])

# hw coast
dt$hw_si[which(dt$hw_si==0 & grepl('Hw',dt$missing) & dt$bec_zone %in% c('CDF','CWH','MH') )] <- convert_hwc_si(dt[which(dt$hw_si==0 & grepl('Hw',dt$missing) & dt$bec_zone %in% c('CDF','CWH','MH') )])

# hw interior
dt$hw_si[which(dt$hw_si==0 & grepl('Hw',dt$missing) & !dt$bec_zone %in% c('CDF','CWH','MH') )] <- convert_hwc_si(dt[which(dt$hw_si==0 & grepl('Hw',dt$missing) & !dt$bec_zone %in% c('CDF','CWH','MH') )])
 

dt$pw_si[which(dt$pw_si==0 & grepl('Pw',dt$missing))] <- convert_pw(dt[which(dt$pw_si==0 & grepl('Pw',dt$missing))]) 

  

  
  #avg_BEC_data <- si_convert(avg_BEC_data)



# write the data
#file_name <- paste0(substr(getwd(),1,1),':/data/data_projects/AR',year,'/PSPL/si_data/pspl_site_index_bec.csv')
#fwrite(avg_BEC_data, file_name, col.names=TRUE, row.names=FALSE, quote = FALSE, sep=",")


#tbl_name <- paste0('pspl_site_index_bec')


# pre delete table
if(dbExistsTable(con,tbl_name)) {
  dbRemoveTable(con,tbl_name)
}


# write to table
dbWriteTable(con,tbl_name,avg_BEC_data,row.names = FALSE)


```

## Conversion on Opening

```{r si_convert_op, eval=FALSE}



# read avg_op_data: table = pspl_site_index_pre_convert_op
q1 <- 'select *  from msyt_2022.pspl_site_index_pre_convert_op'
avg_op_data <- dbGetQuery(con,q1)

setDT(avg_op_data)



# run the conversion

avg_op_data <- si_convert(avg_op_data)

```


## update converted using BEC converted


- update opening_id_id si using BEc avg


```{r bec_op_update, eval=FALSE}



# update from BEC

avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), at_si := ifelse(at_si==0, i.at_si,at_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), ba_si := ifelse(ba_si==0, i.ba_si,ba_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), bg_si := ifelse(bg_si==0, i.bg_si,bg_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), bl_si := ifelse(bl_si==0, i.bl_si,bl_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), cw_si := ifelse(cw_si==0, i.cw_si,cw_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), dr_si := ifelse(dr_si==0, i.dr_si,dr_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), ep_si := ifelse(ep_si==0, i.ep_si,ep_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), fd_si := ifelse(fd_si==0, i.fd_si,fd_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), hm_si := ifelse(hm_si==0, i.hm_si,hm_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), hw_si := ifelse(hw_si==0, i.hw_si,hw_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), lt_si := ifelse(lt_si==0, i.lt_si,lt_si)]  
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), lw_si := ifelse(lw_si==0, i.lw_si,lw_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), pa_si := ifelse(pa_si==0, i.pa_si,pa_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), pl_si := ifelse(pl_si==0, i.pl_si,pl_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), pw_si := ifelse(pw_si==0, i.pw_si,pw_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), py_si := ifelse(py_si==0, i.py_si,py_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), sb_si := ifelse(sb_si==0, i.sb_si,sb_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), se_si := ifelse(se_si==0, i.se_si,se_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), ss_si := ifelse(ss_si==0, i.ss_si,ss_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), sw_si := ifelse(sw_si==0, i.sw_si,sw_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), sx_si := ifelse(sx_si==0, i.sx_si,sx_si)]
avg_op_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), yc_si := ifelse(yc_si==0, i.yc_si,yc_si)]


# add src

avg_op_data$si_src <- 'PSPL'

# writeout the post conversion file
file_name <-  paste0(substr(getwd(),1,1),':/data/data_projects/AR',year,'/PSPL/si_data/pspl_site_index_op.csv')
#fwrite(avg_op_data, file_name, col.names=TRUE, row.names=FALSE, quote = FALSE, sep=",")




tbl_name <- paste0('pspl_site_index_op')

# pre delete table
if(dbExistsTable(con,tbl_name)) {
  dbRemoveTable(con,tbl_name)
}



dbWriteTable(con,tbl_name,avg_op_data,row.names = FALSE)


```

### Feature_id Site Index Conversions

Run the SI conversion on avg_fid_data.   

mean value data by feature



```{r  si_convert_fid,echo=TRUE,message=TRUE,warning=TRUE}


# read avg_fid_data: table = pspl_site_index_pre_convert_fid
# this is the mean value feature_id data

q1 <- paste0('select *  from msyt_',year,'.pspl_site_index_pre_convert_fid')
avg_fid_data <- dbGetQuery(con,q1)

# added to set bec to bec11 based on vri feature
avg_fid_data <-  avg_fid_data %>% select(-bec_zone,-bec_subzone)

bec_fid <- dbGetQuery(con,'select feature_id,bec_zone,bec_subzone from bec11')

avg_fid_data <- left_join(avg_fid_data,bec_fid,by='feature_id')

species <- dbGetQuery(con,'select * from specires_list_current_fid')
 

setDT(avg_fid_data)

# note that si_convert required 0 in place of NA
# si_convert will handle this


# run the SI conversions
avg_fid_data <- si_convert(avg_fid_data)

```

## update features using opening data

- fill in missing si values using openign data


```{r update_fid_from_op,eval=TRUE}

#x1 <- avg_fid_data %>% subset(feature_id %in% c(6171867, 6171929, 6171742, 6171657, 6171983, 6171632, 6171837, 6171666,6171824, 6171792))
#x1 <- x1 %>% select(feature_id, ba_si,fd_si,pl_si,se_si, bec_zone, bec_subzone) %>% arrange(bec_zone,bec_subzone)
#x1$opening_id <- -258070000
#x2 <- avg_op_data %>% subset(opening_id == -258070000) %>% select(opening_id, ba_si,fd_si,pl_si,se_si, bec_zone, bec_subzone)

# add opening_id to fid table

fid_op <- dbGetQuery(con,'select feature_id,opening_id from veg_comp where opening_id is not null and opening_id not in (0,-99)')

avg_fid_data <- left_join(avg_fid_data,fid_op)


# replace 
avg_fid_data[avg_op_data, on=c("opening_id"), at_si := ifelse(at_si==0, i.at_si,at_si)]
avg_fid_data[avg_op_data, on=c("opening_id"), ba_si := ifelse(ba_si==0, i.ba_si,ba_si)]
avg_fid_data[avg_op_data, on=c("opening_id"), bg_si := ifelse(bg_si==0, i.bg_si,bg_si)]
avg_fid_data[avg_op_data, on=c("opening_id"), bl_si := ifelse(bl_si==0, i.bl_si,bl_si)]
avg_fid_data[avg_op_data, on=c("opening_id"), cw_si := ifelse(cw_si==0, i.cw_si,cw_si)]
avg_fid_data[avg_op_data, on=c("opening_id"), dr_si := ifelse(dr_si==0, i.dr_si,dr_si)]
avg_fid_data[avg_op_data, on=c("opening_id"), ep_si := ifelse(ep_si==0, i.ep_si,ep_si)]
avg_fid_data[avg_op_data, on=c("opening_id"), fd_si := ifelse(fd_si==0, i.fd_si,fd_si)]
avg_fid_data[avg_op_data, on=c("opening_id"), hm_si := ifelse(hm_si==0, i.hm_si,hm_si)]
avg_fid_data[avg_op_data, on=c("opening_id"), hw_si := ifelse(hw_si==0, i.hw_si,hw_si)]
avg_fid_data[avg_op_data, on=c("opening_id"), lt_si := ifelse(lt_si==0, i.lt_si,lt_si)]  
avg_fid_data[avg_op_data, on=c("opening_id"), lw_si := ifelse(lw_si==0, i.lw_si,lw_si)]
avg_fid_data[avg_op_data, on=c("opening_id"), pa_si := ifelse(pa_si==0, i.pa_si,pa_si)]
avg_fid_data[avg_op_data, on=c("opening_id"), pl_si := ifelse(pl_si==0, i.pl_si,pl_si)]
avg_fid_data[avg_op_data, on=c("opening_id"), pw_si := ifelse(pw_si==0, i.pw_si,pw_si)]
avg_fid_data[avg_op_data, on=c("opening_id"), py_si := ifelse(py_si==0, i.py_si,py_si)]
avg_fid_data[avg_op_data, on=c("opening_id"), sb_si := ifelse(sb_si==0, i.sb_si,sb_si)]
avg_fid_data[avg_op_data, on=c("opening_id"), se_si := ifelse(se_si==0, i.se_si,se_si)]
avg_fid_data[avg_op_data, on=c("opening_id"), ss_si := ifelse(ss_si==0, i.ss_si,ss_si)]
avg_fid_data[avg_op_data, on=c("opening_id"), sw_si := ifelse(sw_si==0, i.sw_si,sw_si)]
avg_fid_data[avg_op_data, on=c("opening_id"), sx_si := ifelse(sx_si==0, i.sx_si,sx_si)]
avg_fid_data[avg_op_data, on=c("opening_id"), yc_si := ifelse(yc_si==0, i.yc_si,yc_si)]

```



## update converted using BEC converted


- update feature_id si using BEC avg


```{r update_fid_using_bec,echo=TRUE,message=TRUE,warning=TRUE}


avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), at_si := ifelse(at_si==0, i.at_si,at_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), ba_si := ifelse(ba_si==0, i.ba_si,ba_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), bg_si := ifelse(bg_si==0, i.bg_si,bg_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), bl_si := ifelse(bl_si==0, i.bl_si,bl_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), cw_si := ifelse(cw_si==0, i.cw_si,cw_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), dr_si := ifelse(dr_si==0, i.dr_si,dr_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), ep_si := ifelse(ep_si==0, i.ep_si,ep_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), fd_si := ifelse(fd_si==0, i.fd_si,fd_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), hm_si := ifelse(hm_si==0, i.hm_si,hm_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), hw_si := ifelse(hw_si==0, i.hw_si,hw_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), lt_si := ifelse(lt_si==0, i.lt_si,lt_si)]  
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), lw_si := ifelse(lw_si==0, i.lw_si,lw_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), pa_si := ifelse(pa_si==0, i.pa_si,pa_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), pl_si := ifelse(pl_si==0, i.pl_si,pl_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), pw_si := ifelse(pw_si==0, i.pw_si,pw_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), py_si := ifelse(py_si==0, i.py_si,py_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), sb_si := ifelse(sb_si==0, i.sb_si,sb_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), se_si := ifelse(se_si==0, i.se_si,se_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), ss_si := ifelse(ss_si==0, i.ss_si,ss_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), sw_si := ifelse(sw_si==0, i.sw_si,sw_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), sx_si := ifelse(sx_si==0, i.sx_si,sx_si)]
avg_fid_data[avg_BEC_data, on=c("bec_zone","bec_subzone"), yc_si := ifelse(yc_si==0, i.yc_si,yc_si)]



# add src

avg_fid_data$si_src <- 'PSPL'

# write the data
file_name <- paste0(substr(getwd(),1,1),':/data/data_projects/AR',year,'/PSPL/si_data/pspl_site_index_fid.csv')
#fwrite(avg_fid_data, file_name, col.names=TRUE, row.names=FALSE, quote = FALSE, sep=",")


tbl_name <- paste0('pspl_site_index_fid')

# pre delete table
if(dbExistsTable(con,tbl_name)) {
  dbRemoveTable(con,tbl_name)
}

# write to table

dbWriteTable(con,tbl_name,avg_fid_data,row.names = FALSE)

```











```{r cleanUp, eval=FALSE}
 

if(dbExistsTable(con,'pspl_site_index_pre_convert_fid')) {
  dbRemoveTable(con,'pspl_site_index_pre_convert_fid')
}

if(dbExistsTable(con,'pspl_site_index_pre_convert_op')) {
  dbRemoveTable(con,'pspl_site_index_pre_convert_op')
}

if(dbExistsTable(con,'pspl_site_index_pre_convert_bec')) {
  dbRemoveTable(con,'pspl_site_index_pre_convert_bec')
}

#if(dbExistsTable(con,'pspl_init')) {
#  dbRemoveTable(con,'pspl_init')
#}

#if(dbExistsTable(con,'pspl_raw')) {
#  dbRemoveTable(con,'pspl_raw')
#}

```




```{r dump_table}

pg_dump <- function(t_name,folder){
  
  # -O required to negate ownership
  
  f_out <- paste0(folder,'msyt_',year,'_',t_name,'.sql')
  tbl <- paste0('msyt_',year,'.',t_name)
  
  q1 <- paste0("-d ",
               database,
               " -O",
                " -t ",
                tbl,
               " -f ",
               f_out )
  
  system2("pg_dump",args=q1,stderr=TRUE,wait=TRUE)
  #print(q1)
}

```


```{r dump,echo=FALSE,message=FALSE,warning=FALSE}

folder <- paste0(substr(getwd(),1,1),':/data/data_projects/AR',year,'/pg_dump/')

table <- 'pspl_site_index_bec'
pg_dump(table,folder)

table <- 'pspl_site_index_fid'
pg_dump(table,folder)

table <- 'pspl_site_index_op'
pg_dump(table,folder)




# drop the foreign table

#q1 <- paste0('drop foreign table load_',year,'.veg_comp_lyr_r1_poly')
#dbExecute(con,q1)

```



```{r discon}

dbDisconnect(con)

```



End: `r format(Sys.time(),"%c")`