---
title: "Raster Point Intersect 1.0"
author: "D. Waddell"
date: "`r Sys.Date()`"
output: md_document
---

## VRI raster intersect with PSPL points 

Requires 32GB RAM  

- fails on Fort nelson with 8GB 

Assumes that PSPL GDBs are already copied and unzipped


Start: `r Sys.time()`

```{r read_data}


year <- '2022'

library(sf)
library(terra)
library(RPostgreSQL)

# set up for load to PostgreSQL
schema <- paste0('msyt_',year)
opt <- paste0("-c search_path=",schema)
user_name <- 'results'
database <- 'msyt'
con <- dbConnect('PostgreSQL',dbname=database,user=user_name,options=opt)


# read Provincial fid tif
fn1 <- paste0(substr(getwd(),1,1),':/data/data_projects/AR2022/PSPL/vri_raster.tif')
raster_fid <- rast(fn1)


# this is where the unzipped files are placed locally
local_pspl_folder <- paste0(substr(getwd(),1,1),':/data/data_projects/AR2022/PSPL/gdb_data')

# build list of the PSPL gdbs
# list of gdb files to process
f_list <- list.files(local_pspl_folder,full.names = TRUE)
num_gdb = length(f_list)  #number of files to process

```


```{r size_based, eval = FALSE}

dir_size <- function(path, recursive = TRUE) {
  stopifnot(is.character(path))
  files <- list.files(path, full.names = T, recursive = recursive)
  vect_size <- sapply(files, function(x) file.size(x))
  size_files <- sum(vect_size)
  size_files
}

f1 <- paste0(local_pspl_folder,'/Site_Prod_Cassiar.gdb')
cat(dir_size(f1)/10**6, "MB")

```

## process each gdb 

- Read each GDB
- extract feature id from the raster using extract
- join to the point attribute data
- crop the PROV raster at the extent of each GDB + 51m
- export to PostgreSQL table: pspl_intersected

```{r fun}

rast_intersect <- function(r,pf,n){
  
  # r = PROV raster of fid
  # pf = PSPL point set
  # n = counter
  
  #rast_intersect(raster_fid,fname,n)
  r <- raster_fid
  pf <- f_list[7]
  n = 7
  
  t_name <- tools::file_path_sans_ext(basename(pf))
  
  # select where there is at least one NOT NULL si value
  sel_query1 <- paste0('select  at_si,ba_si,bg_si,bl_si,cw_si,dr_si,ep_si,fd_si,hm_si,hw_si,lt_si,lw_si,pa_si,pl_si,pw_si,py_si,sb_si,se_si,ss_si,sw_si,sx_si,yc_si from ',t_name,' where (at_si is not null or ba_si is not null or bg_si is not null or bl_si is not null or cw_si is not null or dr_si is not null or ep_si is not null or fd_si is not null or hm_si is not null or hw_si is not null or lt_si is not null or lw_si is not null or pa_si is not null or pl_si is not null or pw_si is not null or py_si is not null or sb_si is not null or se_si is not null or ss_si is not null or sw_si is not null or sx_si is not null or yc_si is not null)')
  
  sel_query2 <- paste0('select at_si,ba_si,bg_si,bl_si,cw_si,dr_si,ep_si,fd_si,hm_si,hw_si,lt_si,lw_si,pa_si,pl_si,pw_si,py_si,sb_si,se_si,ss_si,sw_si,sx_si,yc_si from ',t_name,' where (at_si > 0 or ba_si > 0 or bg_si > 0 or bl_si > 0 or cw_si > 0 or dr_si > 0 or ep_si > 0 or fd_si > 0 or hm_si > 0 or hw_si > 0 or lt_si > 0 or lw_si > 0 or pa_si > 0 or pl_si > 0 or pw_si > 0 or py_si > 0 or sb_si > 0 or se_si > 0 or ss_si > 0 or sw_si > 0 or sx_si > 0 or yc_si > 0)')
  
  # select only the si columns
  sel_query3 <- paste0('select  at_si,ba_si,bg_si,bl_si,cw_si,dr_si,ep_si,fd_si,hm_si,hw_si,lt_si,lw_si,pa_si,pl_si,pw_si,py_si,sb_si,se_si,ss_si,sw_si,sx_si,yc_si from ',t_name)
  
  # read the point file
  #point_set <- vect(pf)
  
  #point_set <- vect(pf,query = sel_query2)
  
  # Note that terre vect(pf) treats NULL values as zero 
  # could possibly use si > 0 as query 
  point_set <- vect(sf::st_read(pf,query = sel_query1 ))
  
  
  # lower case the names
  #names(point_set) <- c("id_tag","at_si","ba_si","bg_si","bl_si","cw_si","dr_si","ep_si","fd_si","hm_si","hw_si","lt_si","lw_si","pa_si","pl_si","pw_si","py_si","sb_si","se_si","ss_si","sw_si","sx_si","yc_si","bapid","pem_spp","bgc_label","tsa_number")
  
  # number points i pspl
  n_points <- nrow(point_set)


  # add id to point data
  point_set$pspl_id <- seq(1:nrow(point_set))


  #crop raster to point extent + 51

  # define extent from p add 1 m all around
  e <- ext(point_set)
  e[1] <- e[1] - 51
  e[2] <- e[2] + 51
  e[3] <- e[3] - 51
  e[4] <- e[4] + 51

  # crop the raster using the extent
  cropped_raster <- crop(r,e)
  
  
  
  # extract the raster data at the x,y of the points
  x <- extract(cropped_raster,point_set)

  # drop the geometry by changing to data frame
  point_set <- as.data.frame(point_set)


  # join raster data feature_id
  point_set$feature_id <- as.integer(x[,"feature_id"])

  
  
  # set to 1 decimal place 
  # this matches the output from the Biophysical model
  
  # note that this works for CSV
  # export to PostgreSQL will keep as double
  # unless field.types are specified
  # but this has to be a named vector
  # handle the conversion in SQL
  
  point_set[, 1:22] <- round(point_set[, 1:22], digits = 1)

  
  # add a table number to allow tracking
  #point_set$tab_no <- n
  
  # at this point can drop anything with a NULL feature_id
  # or can do this as first step in SQL
  

  # export to csv, append if exists
  #fn3 <- paste0(substr(getwd(),1,1),':/Data/data_projects/PSPL_2021/data/csv/csv',n,'.csv')
  #data.table::fwrite(p,fn3,sep=',',append=FALSE)
  
  # load to PostgreSQL
  if (n ==1) {
    dbWriteTable(con,'pspl_intersected',point_set,row.names=FALSE,overwrite=TRUE)
  } else {
    dbWriteTable(con,'pspl_intersected',point_set,row.names=FALSE,overwrite=FALSE,append = TRUE)
  }
  
  
  rows_out <- nrow(point_set)
  
  fo <- data.frame('num_points' = n_points,'rows_out' = rows_out, 'n' = n)
  
  return(fo)

}

```


```{r intersect_all_units}




# creates unit1 .. unitxx depending on the number of GDBs
  # unit1 does NOT refer to tsa 01
  # it is simply a reference number
if(length(f_list) ==0 ) { print("file list EMPTY")}

# initialize the counter
n <- 1

# create reporting data frame
report <- data.frame('num_points' = '','rows_out' = '', 'n' = '')


#process the file list
    for(fname in f_list){
      
      a <- rast_intersect(raster_fid,fname,n)
      
      report <- rbind(report,a)
      
      n <- n + 1
      
    }



```


```{r report}


library(kableExtra)

kable(report,format="markdown") %>%
kable_styling(bootstrap_options = c("striped"),full_width=F,font_size=13,position = 'left')


```


```{r dump}


pg_dump_table <- function(t_name,folder){
  
  # -O required to negate ownership
  
  f_out <- paste0(folder,'msyt_',year,'_',t_name,'.sql')
  tbl <- paste0('msyt_',year,'.',t_name)
  
  q1 <- paste0("-d ",
               database,
               " -O",
                " -t ",
                tbl,
               " -f ",
               f_out )
  
  system2("pg_dump",args=q1,stderr=TRUE,wait=TRUE)
  print(q1)
  
}

dump_to_folder <- paste0(substr(getwd(),1,1),':/data/data_projects/AR',year,'/PSPL/si_data/')
pg_dump_table('pspl_intersected',dump_to_folder)



dbDisconnect(con)


```




Table 1.  PSPL Summary  

End: `r Sys.time()`


