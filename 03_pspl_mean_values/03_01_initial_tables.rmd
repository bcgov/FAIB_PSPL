---
title: "Generate Initial PSPL tables"
author: "dwaddell"
date: '2022-05-19'
output: md_document
---


# PSPL Method 2022

## PSPL data pre-processing

- Set all 0 values to NULL 
- Join PSPL to VRI opening_id

Note on BEC.  Although BEC values are in the VRI data, they are NOT used.  Instead, the PSPL BEC is used throughout the MSYT process.


## Treatment of NULL values

There are 32 species site index values for each feature_id.  In general, some of these will not have data and thus be null.  When deriving mean values, it is important to exclude these NULL values form the calculation.  It is also important to check that 0 is not substituted for a NULL.  This can happen inadvertently when using a DUCK Typed language such as R.

Start: `r Sys.time()`


### Initialize PostgreSQL Connection

```{r init}

library(RPostgreSQL)

# set up for schema and user
schema <- 'msyt_2022'
opt <- paste0("-c search_path=",schema)



user_name <- 'postgres'
database <- 'msyt'
con <- dbConnect('PostgreSQL',dbname='msyt',user=user_name,options=opt)
#con <- dbConnect('PostgreSQL',dbname='msyt',user=user_name)



db_vac <- function(tb){
  
  com <- shQuote(paste0('vacuum analyze ',tb))
  cmd_arg <- c('-d ' ,database,
                    '-c ' ,com)
  system2('psql', args=cmd_arg,stderr=TRUE)
  
}


```


### Create inital (temp) table

- pspl_init_t

This contains the entire Provincial set of PSPL points

```{sql null_type , connection=con}

drop sequence if exists t1_seq;
create sequence t1_seq;

drop table if exists pspl_init;
drop table if exists pspl_init_t;

select now() as "start create pspl raw initialze";

-- in each unit(n) objectid is unique
-- after the merge, objectid is no longer unique
-- create id as unique

-- use NULLIF to change 0 si values to NULL
-- required so AVG() ignores the 0 values 

create table pspl_init_t as 
select 
	nextval('t1_seq') as id,	-- unique id,
	feature_id,
	NULLIF(at_si,0) as at_si,
	NULLIF(ba_si,0) as ba_si,
	NULLIF(bg_si,0) as bg_si,
	NULLIF(bl_si,0) as bl_si,
	NULLIF(cw_si,0) as cw_si,
	NULLIF(dr_si,0) as dr_si,
	NULLIF(ep_si,0) as ep_si,
	NULLIF(fd_si,0) as fd_si,
	NULLIF(hm_si,0) as hm_si,
	NULLIF(hw_si,0) as hw_si,
	NULLIF(lt_si,0) as lt_si,
	NULLIF(lw_si,0) as lw_si,
	NULLIF(pa_si,0) as pa_si,
	NULLIF(pl_si,0) as pl_si,
	NULLIF(pw_si,0) as pw_si,
	NULLIF(py_si,0) as py_si,
	NULLIF(sb_si,0) as sb_si,
	NULLIF(se_si,0) as se_si,
	NULLIF(ss_si,0) as ss_si,
	NULLIF(sw_si,0) as sw_si,
	NULLIF(sx_si,0) as sx_si,
	NULLIF(yc_si,0) as yc_si,
	trim(substring(bgc_label,1,4)) as bec_zone,
	trim(substring(bgc_label,5,3)) as bec_subzone
from pspl_raw 
where feature_id is not NULL;

select now() as "end init";


```


### Index the intial table

```{sql add_index,connection=con}
 
create index m_idx_sr2 on pspl_init_t(feature_id);


```

```{r vacuum_table}

tbl <- paste0(schema,'.pspl_init_t')
db_vac(tbl)



```

## Create pre convert table 

- pspl_init

```{sql join_opening, connection = con}

drop sequence t1_seq;

-- add opening from veg_comp
drop table if exists pspl_init;
create table pspl_init as
select
	a.id,
	a.feature_id,
	b.opening_id,
	a.at_si,
	a.ba_si,
	a.bg_si,
	a.bl_si,
	a.cw_si,
	a.dr_si,
	a.ep_si,
	a.fd_si,
	a.hm_si,
	a.hw_si,
	a.lt_si,
	a.lw_si,
	a.pa_si,
	a.pl_si,
	a.pw_si,
	a.py_si,
	a.sb_si,
	a.se_si,
	a.ss_si,
	a.sw_si,
	a.sx_si,
	a.yc_si,
	a.bec_zone,
	a.bec_subzone
from pspl_init_t a
left join veg_comp b using(feature_id)
;

drop table pspl_init_t;

create index idx_pspl1 on pspl_init(feature_id);
create index idx_pspl2 on pspl_init(opening_id);


```

```{r analyze}


tbl <- paste0(schema,'.pspl_init')
db_vac(tbl)

```

End: `r Sys.time()`